<!DOCTYPE html>
<html lang="ms">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem RPM - SK Taman Desa 2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar-link:hover { background-color: #374151; transition: 0.3s; }
    .active-tab { background-color: #2563eb !important; border-left: 4px solid #60a5fa; }
    .hidden { display: none !important; }
    body { background-color: #f3f4f6; }
  </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen font-sans">

  <aside class="w-full md:w-64 bg-gray-900 text-white flex flex-col shadow-lg z-10">
    <div class="p-6 text-center border-b border-gray-700">
      <img src="https://i.imgur.com/EYmhQUu.png" alt="Logo SK Taman Desa 2" class="w-24 h-24 mx-auto mb-3 object-contain bg-white rounded-full p-1 shadow-md">
      <h1 class="text-sm font-bold uppercase tracking-wider leading-tight">Sekolah Kebangsaan Taman Desa 2</h1>
      <p class="text-xs text-blue-400 mt-2 font-semibold">Sistem RPM Digital</p>
    </div>
    <nav class="flex-grow p-4 space-y-2">
      <button onclick="showTab('rekod')" id="btn-rekod" class="sidebar-link w-full text-left p-3 rounded active-tab"><i class="fas fa-edit w-6"></i> 1. Rekod</button>
      <button onclick="showTab('paparan')" id="btn-paparan" class="sidebar-link w-full text-left p-3 rounded"><i class="fas fa-chart-line w-6"></i> 2. Paparan</button>
      <button onclick="showTab('kemaskini')" id="btn-kemaskini" class="sidebar-link w-full text-left p-3 rounded"><i class="fas fa-tasks w-6"></i> 3. Kemaskini</button>
    </nav>
  </aside>

  <main class="flex-grow p-4 md:p-8 overflow-y-auto">
    
    <section id="section-rekod" class="space-y-6">
      <h2 class="text-3xl font-bold text-gray-800 border-b-2 border-blue-500 pb-2">1. Rekod Perkembangan Murid</h2>
      
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 class="font-bold text-lg mb-4 text-blue-800"><i class="fas fa-database mr-2"></i>A. Muat Naik Pangkalan Data (CSV)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="p-4 border rounded-lg bg-blue-50 border-blue-200">
            <h4 class="font-semibold text-blue-800 mb-3">Database Murid</h4>
            <div class="flex flex-col gap-3">
              <input type="file" id="csvMurid" accept=".csv" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
              <div class="flex gap-2 mt-2">
                <button onclick="prosesCSV('murid')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold shadow hover:bg-blue-700 w-full transition"><i class="fas fa-upload mr-1"></i> Hantar</button>
                <button onclick="padamData('murid')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold shadow hover:bg-red-600 w-full transition"><i class="fas fa-trash mr-1"></i> Padam</button>
              </div>
            </div>
          </div>
          <div class="p-4 border rounded-lg bg-green-50 border-green-200">
            <h4 class="font-semibold text-green-800 mb-3">Database Subjek & Topik</h4>
            <div class="flex flex-col gap-3">
              <input type="file" id="csvSubjek" accept=".csv" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700 cursor-pointer">
              <div class="flex gap-2 mt-2">
                <button onclick="prosesCSV('subjek')" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-semibold shadow hover:bg-green-700 w-full transition"><i class="fas fa-upload mr-1"></i> Hantar</button>
                <button onclick="padamData('subjek')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold shadow hover:bg-red-600 w-full transition"><i class="fas fa-trash mr-1"></i> Padam</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 class="font-bold text-lg mb-4 text-blue-800"><i class="fas fa-users-cog mr-2"></i>B. Borang Pentaksiran Murid</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Tarikh</label><input type="date" id="tarikh" class="border border-gray-300 p-2 rounded w-full bg-white"></div>
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Kelas</label><select id="sel-kelas" class="border border-gray-300 p-2 rounded w-full bg-white"><option value="">Pilih...</option></select></div>
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Subjek</label><select id="sel-subjek" class="border border-gray-300 p-2 rounded w-full bg-white"><option value="">Pilih...</option></select></div>
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Topik</label><select id="sel-topik" class="border border-gray-300 p-2 rounded w-full bg-white"><option value="">Pilih...</option></select></div>
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Kemahiran</label><select id="sel-kemahiran" class="border border-gray-300 p-2 rounded w-full bg-white"><option value="">Pilih...</option></select></div>
        </div>
        
        <div class="mb-4 bg-gray-100 border border-gray-200 p-3 rounded-lg flex flex-col md:flex-row gap-3 items-center justify-between">
            <span class="font-bold text-gray-700 text-sm"><i class="fas fa-layer-group mr-2"></i>Set TP Pukal:</span>
            <div class="flex flex-wrap gap-2">
                <button onclick="setPukal('TP1')" class="px-3 py-1 bg-white border border-red-500 text-red-600 hover:bg-red-500 hover:text-white rounded font-bold text-xs shadow-sm">TP1</button>
                <button onclick="setPukal('TP2')" class="px-3 py-1 bg-white border border-yellow-400 text-yellow-600 hover:bg-yellow-400 hover:text-white rounded font-bold text-xs shadow-sm">TP2</button>
                <button onclick="setPukal('TP3')" class="px-3 py-1 bg-white border border-orange-500 text-orange-600 hover:bg-orange-500 hover:text-white rounded font-bold text-xs shadow-sm">TP3</button>
                <button onclick="setPukal('TP4')" class="px-3 py-1 bg-white border border-green-500 text-green-600 hover:bg-green-500 hover:text-white rounded font-bold text-xs shadow-sm">TP4</button>
                <button onclick="setPukal('TP5')" class="px-3 py-1 bg-white border border-blue-500 text-blue-600 hover:bg-blue-500 hover:text-white rounded font-bold text-xs shadow-sm">TP5</button>
                <button onclick="setPukal('TP6')" class="px-3 py-1 bg-white border border-purple-500 text-purple-600 hover:bg-purple-500 hover:text-white rounded font-bold text-xs shadow-sm">TP6</button>
                <button onclick="setPukal('TH')" class="px-3 py-1 bg-white border border-gray-500 text-gray-600 hover:bg-gray-500 hover:text-white rounded font-bold text-xs shadow-sm">TH</button>
                <button onclick="setPukal('TD')" class="px-3 py-1 bg-white border border-pink-500 text-pink-600 hover:bg-pink-500 hover:text-white rounded font-bold text-xs shadow-sm">TD</button>
            </div>
        </div>

        <div class="border border-gray-200 rounded-lg overflow-x-auto">
          <table class="w-full text-left text-sm min-w-[600px]">
            <thead class="bg-blue-50 text-blue-800">
              <tr><th class="p-3 w-12 text-center border-b">Bil</th><th class="p-3 border-b">Nama Murid</th><th class="p-3 w-auto text-center border-b">Tahap Penguasaan (TP)</th></tr>
            </thead>
            <tbody id="student-list" class="divide-y divide-gray-200">
              <tr><td colspan="3" class="p-6 text-center text-gray-500 italic">Sila pilih kelas di atas...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mt-6 flex flex-wrap gap-4 items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200">
          <button onclick="resetBorang()" class="bg-gray-500 text-white px-6 py-2 rounded shadow hover:bg-gray-600 text-sm font-semibold"><i class="fas fa-undo mr-1"></i> Padam Pilihan</button>
          <button id="btn-simpan" onclick="simpanRekod()" class="bg-blue-600 text-white px-8 py-2 rounded shadow-lg hover:bg-blue-700 transition text-lg font-bold"><i class="fas fa-save mr-2"></i> SIMPAN</button>
        </div>
      </div>
    </section>

    <section id="section-paparan" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b-2 border-blue-500 pb-2">
        <h2 class="text-3xl font-bold text-gray-800">2. Paparan & Statistik</h2>
        <button onclick="muatTurunExcel()" class="mt-4 md:mt-0 bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition text-sm font-bold flex items-center">
          <i class="fas fa-file-excel mr-2 text-lg"></i> Muat Turun Excel
        </button>
      </div>

      <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
        <h3 class="text-sm font-bold text-gray-500 uppercase mb-3">Carian Terperinci</h3>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
          <div><label class="text-xs text-gray-500">Tarikh</label><input type="date" id="paparan-tarikh" class="border p-2 rounded text-sm w-full bg-gray-50"></div>
          <div><label class="text-xs text-gray-500">Kelas</label><select id="paparan-kelas" class="border p-2 rounded text-sm w-full bg-gray-50"><option value="">Semua Kelas</option></select></div>
          <div><label class="text-xs text-gray-500">Nama Murid</label><select id="paparan-murid" class="border p-2 rounded text-sm w-full bg-gray-50"><option value="">Semua Murid</option></select></div>
          <div><label class="text-xs text-gray-500">Subjek</label><select id="paparan-subjek" class="border p-2 rounded text-sm w-full bg-gray-50"><option value="">Semua Subjek</option></select></div>
          <div><label class="text-xs text-gray-500">TP</label><select id="paparan-tp" class="border p-2 rounded text-sm w-full bg-gray-50">
            <option value="">Semua TP</option><option value="TP1">TP1</option><option value="TP2">TP2</option><option value="TP3">TP3</option><option value="TP4">TP4</option><option value="TP5">TP5</option><option value="TP6">TP6</option>
          </select></div>
          <button onclick="tapisPaparan()" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-sm font-semibold shadow w-full"><i class="fas fa-search mr-1"></i> Cari</button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-md text-gray-800">
          <p class="text-gray-500 text-sm font-bold uppercase mb-2 text-center border-b pb-1">Statistik TP Keseluruhan</p>
          <div class="relative h-48 w-full flex items-center justify-center text-sm text-gray-400 italic" id="wrap-chartTP">Sila buat carian...</div>
        </div>
        <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-md text-gray-800">
          <p class="text-gray-500 text-sm font-bold uppercase mb-2 text-center border-b pb-1">Statistik Subjek (Semasa)</p>
          <div class="relative h-48 w-full flex items-center justify-center text-sm text-gray-400 italic" id="wrap-chartSubjek">Sila buat carian...</div>
        </div>
        <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-md text-gray-800">
          <p class="text-gray-500 text-sm font-bold uppercase mb-2 text-center border-b pb-1">Statistik Murid (Individu)</p>
          <div class="relative h-48 w-full flex items-center justify-center text-xs text-center text-gray-400 italic px-4" id="wrap-chartIndividu">
             Sila pilih Nama Murid & Subjek untuk melihat TP Tertinggi Individu
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">Senarai Pentaksiran Terkini</h3>
        <div class="overflow-x-auto">
          <table id="table-paparan-export" class="w-full text-sm text-left border">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3 border">Tarikh</th><th class="p-3 border">Kelas</th><th class="p-3 border">Subjek</th><th class="p-3 border">Topik</th><th class="p-3 border">Kemahiran</th><th class="p-3 border">Nama Murid</th><th class="p-3 border text-center">TP</th>
              </tr>
            </thead>
            <tbody id="tbody-paparan" class="divide-y">
              <tr><td colspan="7" class="p-6 text-center text-gray-400 italic">Memuatkan data pangkalan...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-kemaskini" class="hidden space-y-6">
      <div class="border-b-2 border-blue-500 pb-2 flex justify-between items-end">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">3. Kemaskini</h2>
          <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mt-1">Pengurusan & Suntingan Data</p>
        </div>
        <button onclick="fetchRekodDariSheet()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-yellow-600 shadow transition flex items-center">
          <i class="fas fa-sync-alt mr-2"></i> Segar Semula (Sync)
        </button>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <p class="text-sm text-gray-600 mb-4 bg-blue-50 p-3 rounded border border-blue-100"><i class="fas fa-info-circle mr-2 text-blue-500"></i>Cari rekod yang ingin dikemaskini. Tekan <b>Edit</b> untuk menukar tahap penguasaan murid, atau <b>Padam Carian</b> jika ingin memadam secara pukal.</p>
        
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 items-end">
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Tarikh Mula</label><input type="date" id="kemaskini-tkh-mula" class="border p-2 rounded w-full text-sm bg-gray-50"></div>
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Tarikh Tamat</label><input type="date" id="kemaskini-tkh-tamat" class="border p-2 rounded w-full text-sm bg-gray-50"></div>
          <div><label class="block text-xs font-semibold text-gray-600 mb-1">Kelas</label><select id="kemaskini-kelas" class="border p-2 rounded w-full text-sm bg-gray-50"><option value="">Semua Kelas</option></select></div>
          <button onclick="tapisKemaskini()" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 font-semibold shadow w-full text-sm h-10"><i class="fas fa-filter mr-2"></i>Tapis Data</button>
          <button onclick="padamDataCarian()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 font-semibold shadow w-full text-sm h-10"><i class="fas fa-trash-alt mr-2"></i>Padam Carian</button>
        </div>

        <div class="overflow-x-auto border rounded-lg">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3 border">Tarikh</th><th class="p-3 border">Murid</th><th class="p-3 border">Kelas</th><th class="p-3 border">Subjek</th><th class="p-3 border text-center">TP Semasa</th><th class="p-3 border text-center w-40">Tindakan</th>
              </tr>
            </thead>
            <tbody id="tbody-kemaskini" class="divide-y">
               <tr><td colspan="6" class="p-6 text-center text-gray-400 italic">Memuatkan data dari pangkalan...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <script>
    let globalSubjekData = [];
    let globalRekodData = [];
    let globalFilteredKemaskini = []; // Pembolehubah simpan data carian semasa
    let chartTP, chartSubjek, chartIndividu; // Variable untuk canvas graf

    // ================= PENGURUSAN TAB =================
    function showTab(tabId) {
      document.getElementById('section-rekod').classList.add('hidden');
      document.getElementById('section-paparan').classList.add('hidden');
      document.getElementById('section-kemaskini').classList.add('hidden');
      
      document.getElementById('btn-rekod').classList.remove('active-tab');
      document.getElementById('btn-paparan').classList.remove('active-tab');
      document.getElementById('btn-kemaskini').classList.remove('active-tab');
      
      document.getElementById('section-' + tabId).classList.remove('hidden');
      document.getElementById('btn-' + tabId).classList.add('active-tab');

      if(tabId === 'paparan' || tabId === 'kemaskini') {
        fetchRekodDariSheet();
      }
    }

    // ================= FETCH AWAL =================
    document.addEventListener("DOMContentLoaded", () => {
      google.script.run.withSuccessHandler(d => {
        populateDropdown('sel-kelas', d, 'Kelas');
        populateDropdown('paparan-kelas', d, 'Semua Kelas');
        populateDropdown('kemaskini-kelas', d, 'Semua Kelas');
      }).getSenaraiKelas();
      
      muatDataSubjek();
      
      // Event Listener Rekod
      document.getElementById('sel-kelas').addEventListener('change', function() {
        const kelasDipilih = this.value;
        const jadual = document.getElementById('student-list');
        if(kelasDipilih) {
          jadual.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-blue-500 font-bold"><i class="fas fa-spinner fa-spin mr-2"></i> Memuatkan nama murid...</td></tr>';
          google.script.run.withSuccessHandler(populateMuridTable).getMuridByKelas(kelasDipilih);
        } else {
          jadual.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-500 italic">Sila pilih kelas...</td></tr>';
        }
      });
      document.getElementById('sel-subjek').addEventListener('change', function() {
        const subjekDipilih = this.value; let topikSet = new Set();
        globalSubjekData.forEach(item => { if(item.subjek === subjekDipilih && item.topik) topikSet.add(item.topik); });
        populateDropdown('sel-topik', Array.from(topikSet).sort(), 'Topik');
        populateDropdown('sel-kemahiran', [], 'Kemahiran');
      });
      document.getElementById('sel-topik').addEventListener('change', function() {
        const subjekDipilih = document.getElementById('sel-subjek').value; const topikDipilih = this.value;
        let kemahiranSet = new Set();
        globalSubjekData.forEach(item => {
          if(item.subjek === subjekDipilih && item.topik === topikDipilih && item.kemahiran) kemahiranSet.add(item.kemahiran);
        });
        populateDropdown('sel-kemahiran', Array.from(kemahiranSet).sort(), 'Kemahiran');
      });

      // Event Listener Paparan Kelas -> Dropdown Murid dinamik
      document.getElementById('paparan-kelas').addEventListener('change', function() {
         const kls = this.value;
         const selMurid = document.getElementById('paparan-murid');
         selMurid.innerHTML = '<option value="">Semua Murid</option>';
         if(kls) {
            let muridSet = new Set();
            globalRekodData.forEach(r => { if(r.kelas === kls) muridSet.add(r.nama); });
            Array.from(muridSet).sort().forEach(m => {
                selMurid.innerHTML += `<option value="${m}">${m}</option>`;
            });
         }
         tapisPaparan();
      });
    });

    function muatDataSubjek() {
      google.script.run.withSuccessHandler(function(data) {
        globalSubjekData = data;
        let subjekSet = new Set();
        data.forEach(item => { if(item.subjek) subjekSet.add(item.subjek); });
        let subjekArr = Array.from(subjekSet).sort();
        populateDropdown('sel-subjek', subjekArr, 'Subjek');
        populateDropdown('paparan-subjek', subjekArr, 'Semua Subjek');
      }).getDataSubjekRaw();
    }

    function populateDropdown(id, senarai, label) {
      const sel = document.getElementById(id);
      let valEmpty = "";
      sel.innerHTML = `<option value="${valEmpty}">${label}</option>`;
      if(senarai) senarai.forEach(item => { sel.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    // ================= CSV =================
    function prosesCSV(jenis) {
      const inputId = jenis === 'murid' ? 'csvMurid' : 'csvSubjek';
      const fileInput = document.getElementById(inputId);
      if (!fileInput.files[0]) { alert("Sila pilih fail CSV!"); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result; const rows = text.split('\n').map(row => row.split(',')).filter(row => row.length > 0 && row[0].trim() !== ''); 
        if(rows.length === 0) { alert("Fail CSV kosong/ralat."); return; }
        alert("Sedang menghantar data...");
        google.script.run.withSuccessHandler(function(msj) {
          alert(msj); fileInput.value = '';
          if(jenis === 'murid') google.script.run.withSuccessHandler(d => { populateDropdown('sel-kelas', d, 'Kelas'); populateDropdown('paparan-kelas', d, 'Semua Kelas'); populateDropdown('kemaskini-kelas', d, 'Semua Kelas'); }).getSenaraiKelas();
          if(jenis === 'subjek') muatDataSubjek(); 
        }).simpanDataCSV(rows, jenis);
      }; reader.readAsText(fileInput.files[0]);
    }
    
    function padamData(jenis) {
      if(confirm("AWAS: Padam semua data " + jenis + "?")) {
        google.script.run.withSuccessHandler(msj => {
            alert(msj);
            if(jenis === 'murid') { populateDropdown('sel-kelas', [], 'Kelas'); populateDropdown('paparan-kelas', [], 'Semua Kelas'); populateDropdown('kemaskini-kelas', [], 'Semua Kelas'); }
            if(jenis === 'subjek') { globalSubjekData = []; populateDropdown('sel-subjek', [], 'Subjek'); populateDropdown('paparan-subjek', [], 'Semua Subjek'); }
        }).padamDataSheet(jenis);
      }
    }

    // ================= BORANG TP =================
    function createBtn(label, borderColor, textColor, bgColor) {
        return `<button type="button" onclick="pilihTP(this, '${label}')" class="tp-btn border ${borderColor} ${textColor} hover:${bgColor} hover:text-white px-2 py-1 rounded text-xs font-bold transition focus:outline-none" data-bg="${bgColor}" data-text="${textColor}">${label}</button>`;
    }
    
    function populateMuridTable(senaraiMurid) {
      const tbody = document.getElementById('student-list'); tbody.innerHTML = ''; 
      if(!senaraiMurid || senaraiMurid.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-red-500">Tiada murid.</td></tr>'; return; }
      senaraiMurid.forEach((nama, i) => {
        tbody.innerHTML += `<tr class="hover:bg-gray-50 student-row border-b border-gray-100"><td class="p-3 text-center text-gray-500 font-semibold">${i + 1}</td><td class="p-3 font-medium stu-name text-gray-800">${nama}</td><td class="p-3 text-center"><div class="flex flex-wrap gap-1 justify-center tp-group"><input type="hidden" class="stu-tp" value="">${createBtn('TP1', 'border-red-500', 'text-red-600', 'bg-red-500')}${createBtn('TP2', 'border-yellow-400', 'text-yellow-600', 'bg-yellow-400')}${createBtn('TP3', 'border-orange-500', 'text-orange-600', 'bg-orange-500')}${createBtn('TP4', 'border-green-500', 'text-green-600', 'bg-green-500')}${createBtn('TP5', 'border-blue-500', 'text-blue-600', 'bg-blue-500')}${createBtn('TP6', 'border-purple-500', 'text-purple-600', 'bg-purple-500')}${createBtn('TH', 'border-gray-500', 'text-gray-600', 'bg-gray-500')}${createBtn('TD', 'border-pink-500', 'text-pink-600', 'bg-pink-500')}</div></td></tr>`;
      });
    }
    
    function pilihTP(btn, nilai) {
      const container = btn.closest('.tp-group'); const hiddenInput = container.querySelector('.stu-tp');
      container.querySelectorAll('.tp-btn').forEach(b => { b.classList.remove(b.getAttribute('data-bg'), 'text-white'); b.classList.add(b.getAttribute('data-text')); });
      btn.classList.remove(btn.getAttribute('data-text')); btn.classList.add(btn.getAttribute('data-bg'), 'text-white');
      hiddenInput.value = nilai;
    }
    
    function setPukal(nilai) { document.querySelectorAll('.tp-group').forEach(group => { group.querySelectorAll('.tp-btn').forEach(btn => { if(btn.innerText.trim() === nilai) btn.click(); }); }); }
    
    // Reset Data (Hanya buang pilihan TP, kekalkan Tarikh/Kelas)
    function resetBorang() {
      document.querySelectorAll('.tp-btn').forEach(b => { b.classList.remove(b.getAttribute('data-bg'), 'text-white'); b.classList.add(b.getAttribute('data-text')); });
      document.querySelectorAll('.stu-tp').forEach(input => input.value = '');
    }

    function simpanRekod() {
      const tkh = document.getElementById('tarikh').value, kl = document.getElementById('sel-kelas').value, sb = document.getElementById('sel-subjek').value, tpk = document.getElementById('sel-topik').value, kmh = document.getElementById('sel-kemahiran').value;
      if(!tkh || !kl || !sb || !tpk || !kmh) { alert("Sila lengkapkan maklumat borang di atas!"); return; }
      
      const rows = document.querySelectorAll('.student-row'); let data = []; const ts = new Date().toLocaleString('ms-MY');
      rows.forEach(row => { const nm = row.querySelector('.stu-name').innerText, tpVal = row.querySelector('.stu-tp').value; if (tpVal !== "") data.push([ts, tkh, kl, sb, tpk, kmh, nm, tpVal]); });
      if(data.length === 0) { alert("Pilih TP untuk sekurang-kurangnya seorang murid!"); return; }

      const btn = document.getElementById('btn-simpan'); btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> MENYIMPAN...';
      google.script.run.withSuccessHandler(function(mesej) {
        alert(mesej); btn.innerHTML = '<i class="fas fa-save mr-2"></i> SIMPAN'; 
        resetBorang(); // Kosongkan TP secara automatik tanpa popup
      }).withFailureHandler(function(err){ alert("Gagal: " + err.message); btn.innerHTML = '<i class="fas fa-save mr-2"></i> SIMPAN'; }).simpanDataRekod(data);
    }

    // ================= PAPARAN & GRAF BAR CHART =================
    function fetchRekodDariSheet() {
       document.getElementById('tbody-paparan').innerHTML = '<tr><td colspan="7" class="p-6 text-center text-blue-500 font-bold"><i class="fas fa-spinner fa-spin mr-2"></i> Menyegerak data...</td></tr>';
       document.getElementById('tbody-kemaskini').innerHTML = '<tr><td colspan="6" class="p-6 text-center text-blue-500 font-bold"><i class="fas fa-spinner fa-spin mr-2"></i> Menyegerak data...</td></tr>';
       
       google.script.run.withSuccessHandler(function(data) {
           // Simpan localId untuk manipulasi Edit/Padam dengan mudah
           globalRekodData = data.map((d, index) => ({...d, localId: index}));
           tapisPaparan(); 
           tapisKemaskini();
       }).getRekodTP();
    }

    function tapisPaparan() {
        const tkh = document.getElementById('paparan-tarikh').value;
        const kl = document.getElementById('paparan-kelas').value;
        const nm = document.getElementById('paparan-murid').value;
        const sb = document.getElementById('paparan-subjek').value;
        const tp = document.getElementById('paparan-tp').value;

        let filtered = globalRekodData.filter(r => {
            let tkhMatch = true; if (tkh) tkhMatch = r.tarikh.includes(tkh) || r.tarikh === tkh; 
            return tkhMatch && (kl === "" || r.kelas === kl) && (nm === "" || r.nama === nm) && (sb === "" || r.subjek === sb) && (tp === "" || r.tp === tp);
        });

        // Jadual
        const tbody = document.getElementById('tbody-paparan'); tbody.innerHTML = '';
        if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-500">Tiada rekod dijumpai.</td></tr>'; } 
        else {
            filtered.forEach(r => { tbody.innerHTML += `<tr class="hover:bg-gray-50"><td class="p-2 border">${r.tarikh}</td><td class="p-2 border">${r.kelas}</td><td class="p-2 border">${r.subjek}</td><td class="p-2 border">${r.topik}</td><td class="p-2 border">${r.kemahiran}</td><td class="p-2 border font-medium">${r.nama}</td><td class="p-2 border text-center font-bold text-blue-600">${r.tp}</td></tr>`; });
        }

        renderGraf(filtered, nm, sb);
    }

    function renderGraf(filtered, nm, sb) {
        // Graf 1: TP Keseluruhan
        let tpCounts = {"TP1":0, "TP2":0, "TP3":0, "TP4":0, "TP5":0, "TP6":0};
        filtered.forEach(r => { if(tpCounts[r.tp] !== undefined) tpCounts[r.tp]++; });
        document.getElementById('wrap-chartTP').innerHTML = '<canvas id="chartTP"></canvas>';
        chartTP = new Chart(document.getElementById('chartTP'), {
            type: 'bar',
            data: { labels: Object.keys(tpCounts), datasets: [{ label: 'Bilangan Rekod', data: Object.values(tpCounts), backgroundColor: '#3b82f6', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // Graf 2: Subjek Semasa
        let subjekCounts = {};
        filtered.forEach(r => { subjekCounts[r.subjek] = (subjekCounts[r.subjek] || 0) + 1; });
        document.getElementById('wrap-chartSubjek').innerHTML = '<canvas id="chartSubjek"></canvas>';
        chartSubjek = new Chart(document.getElementById('chartSubjek'), {
            type: 'bar',
            data: { labels: Object.keys(subjekCounts).length ? Object.keys(subjekCounts) : ['Tiada Data'], datasets: [{ label: 'Bilangan Data', data: Object.keys(subjekCounts).length ? Object.values(subjekCounts) : [0], backgroundColor: '#8b5cf6', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // Graf 3: Individu (TP Tertinggi mengikut Kemahiran)
        if (nm !== "" && sb !== "") {
            let userSkills = {};
            filtered.forEach(r => {
                let currentTPNum = parseInt(r.tp.replace('TP', '')) || 0;
                if(!userSkills[r.kemahiran] || currentTPNum > userSkills[r.kemahiran]) {
                    userSkills[r.kemahiran] = currentTPNum;
                }
            });
            document.getElementById('wrap-chartIndividu').innerHTML = '<canvas id="chartIndividu"></canvas>';
            chartIndividu = new Chart(document.getElementById('chartIndividu'), {
                type: 'bar',
                data: { labels: Object.keys(userSkills), datasets: [{ label: 'Tahap Penguasaan Tertinggi', data: Object.values(userSkills), backgroundColor: '#10b981', borderRadius: 4 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 6, ticks: { stepSize: 1, callback: function(val) { return 'TP' + val; } } } }
                }
            });
        } else {
            document.getElementById('wrap-chartIndividu').innerHTML = 'Sila pilih Nama Murid & Subjek untuk melihat TP Tertinggi Individu';
        }
    }

    function muatTurunExcel() {
        let table = document.getElementById("table-paparan-export");
        let rows = table.querySelectorAll("tr"); let csv = [];
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
            csv.push(row.join(","));
        }
        let a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv.join("\n")], { type: "text/csv" })); a.download = "Data_RPM_Murid.csv"; a.click();
    }

    // ================= KEMASKINI (EDIT & PADAM) =================
    function tapisKemaskini() {
        const mula = document.getElementById('kemaskini-tkh-mula').value;
        const tamat = document.getElementById('kemaskini-tkh-tamat').value;
        const kl = document.getElementById('kemaskini-kelas').value;

        let filtered = globalRekodData.filter(r => {
            let okKelas = (kl === "" || r.kelas === kl);
            let okMula = (mula === "") ? true : (new Date(r.tarikh) >= new Date(mula));
            let okTamat = (tamat === "") ? true : (new Date(r.tarikh) <= new Date(tamat));
            return okKelas && okMula && okTamat;
        });

        // Simpan hasil carian ke global variable
        globalFilteredKemaskini = filtered;

        const tbody = document.getElementById('tbody-kemaskini'); tbody.innerHTML = '';
        if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500">Tiada rekod dijumpai.</td></tr>'; } 
        else {
            filtered.forEach(r => {
                tbody.innerHTML += `
                <tr class="hover:bg-gray-50" id="row-${r.localId}">
                    <td class="p-3">${r.tarikh}</td><td class="p-3 font-medium">${r.nama}</td><td class="p-3">${r.kelas}</td>
                    <td class="p-3 leading-tight">${r.subjek}<br><span class="text-xs text-gray-400">${r.topik} - ${r.kemahiran}</span></td>
                    <td class="p-3 text-center font-bold text-blue-600" id="tp-val-${r.localId}">${r.tp}</td>
                    <td class="p-3 text-center" id="action-${r.localId}">
                        <div class="flex gap-1 justify-center">
                            <button onclick="bukaEdit(${r.localId})" class="text-white bg-amber-500 px-3 py-1 rounded hover:bg-amber-600 shadow text-xs font-bold"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="padamRekod(${r.localId})" class="text-white bg-red-500 px-3 py-1 rounded hover:bg-red-600 shadow text-xs font-bold"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        }
    }

    function padamDataCarian() {
        if (!globalFilteredKemaskini || globalFilteredKemaskini.length === 0) {
            alert("Tiada data carian dipaparkan untuk dipadam.");
            return;
        }
        
        // Minta pengesahan berganda supaya tidak tersalah padam
        if (!confirm("AWAS: Anda pasti mahu memadam " + globalFilteredKemaskini.length + " rekod yang dipaparkan ini secara kekal?\n\nTindakan ini tidak boleh diundur.")) return;
        
        // Sediakan data untuk dihantar ke Code.gs
        let toDelete = globalFilteredKemaskini.map(r => ({ timestamp: r.timestamp, nama: r.nama }));
        
        document.getElementById('tbody-kemaskini').innerHTML = '<tr><td colspan="6" class="p-6 text-center text-red-500 font-bold"><i class="fas fa-spinner fa-spin mr-2"></i> Sedang memadam ' + toDelete.length + ' rekod... Sila tunggu sebentar.</td></tr>';
        
        google.script.run.withSuccessHandler(function(msj) {
            alert(msj);
            fetchRekodDariSheet(); // Muat semula jadual selepas selesai
        }).withFailureHandler(function(err){ 
            alert("Ralat semasa memadam: " + err.message); 
            fetchRekodDariSheet(); 
        }).padamRekodPukal(toDelete);
    }

    function bukaEdit(localId) {
        let r = globalRekodData.find(x => x.localId === localId);
        if(!r) return;
        
        let selHtml = `<select id="edit-sel-${localId}" class="border border-blue-400 rounded p-1 text-xs bg-white">`;
        ["TP1","TP2","TP3","TP4","TP5","TP6","TH","TD"].forEach(o => { selHtml += `<option value="${o}" ${o===r.tp ? 'selected':''}>${o}</option>`; });
        selHtml += `</select>`;
        
        document.getElementById(`tp-val-${localId}`).innerHTML = selHtml;
        document.getElementById(`action-${localId}`).innerHTML = `
            <div class="flex gap-1 justify-center">
                <button onclick="simpanEdit(${localId})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-xs shadow"><i class="fas fa-check"></i></button>
                <button onclick="batalEdit(${localId})" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-xs shadow"><i class="fas fa-times"></i></button>
            </div>`;
    }

    function batalEdit(localId) {
        let r = globalRekodData.find(x => x.localId === localId);
        document.getElementById(`tp-val-${localId}`).innerHTML = r.tp;
        document.getElementById(`action-${localId}`).innerHTML = `
            <div class="flex gap-1 justify-center">
                <button onclick="bukaEdit(${localId})" class="text-white bg-amber-500 px-3 py-1 rounded hover:bg-amber-600 shadow text-xs font-bold"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="padamRekod(${localId})" class="text-white bg-red-500 px-3 py-1 rounded hover:bg-red-600 shadow text-xs font-bold"><i class="fas fa-trash"></i></button>
            </div>`;
    }

    function simpanEdit(localId) {
        let r = globalRekodData.find(x => x.localId === localId);
        const newTP = document.getElementById(`edit-sel-${localId}`).value;
        const actTd = document.getElementById(`action-${localId}`);
        actTd.innerHTML = `<i class="fas fa-spinner fa-spin text-blue-500"></i>`;
        
        google.script.run.withSuccessHandler(function(msj) {
            r.tp = newTP; // update memory
            batalEdit(localId); 
        }).withFailureHandler(function(err){ alert("Ralat: " + err.message); batalEdit(localId); }).updateRekodTP(r.timestamp, r.nama, newTP);
    }

    function padamRekod(localId) {
        if(!confirm("Anda pasti mahu memadam rekod ini secara kekal?")) return;
        let r = globalRekodData.find(x => x.localId === localId);
        document.getElementById(`action-${localId}`).innerHTML = `<i class="fas fa-spinner fa-spin text-red-500"></i>`;
        
        google.script.run.withSuccessHandler(function(msj) {
            document.getElementById(`row-${localId}`).remove();
            globalRekodData = globalRekodData.filter(x => x.localId !== localId);
            globalFilteredKemaskini = globalFilteredKemaskini.filter(x => x.localId !== localId); // kemaskini list filter juga
        }).withFailureHandler(function(err){ alert("Gagal memadam: " + err.message); batalEdit(localId); }).padamRekodTunggal(r.timestamp, r.nama);
    }
  </script>
</body>
</html>
